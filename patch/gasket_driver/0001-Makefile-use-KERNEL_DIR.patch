From 887641d43fa8a53943c4edb59c9bdf5abe98357f Mon Sep 17 00:00:00 2001
From: Ed Swarthout <ed.swarthout@gmail.com>
Date: Wed, 13 Aug 2025 15:16:53 -0500
Subject: [PATCH] Makefile use KERNEL_DIR

Signed-off-by: Ed Swarthout <ed.swarthout@gmail.com>
---
 src/Makefile | 22 ++++++++++++++++++----
 1 file changed, 18 insertions(+), 4 deletions(-)

diff --git a/src/Makefile b/src/Makefile
index ef976ea..1f27792 100644
--- a/src/Makefile
+++ b/src/Makefile
@@ -8,10 +8,24 @@ obj-m += apex.o
 gasket-objs	:= gasket_core.o gasket_ioctl.o gasket_interrupt.o gasket_page_table.o gasket_sysfs.o
 apex-objs	:= apex_driver.o
 
-KVERSION := $(shell uname -r)
+KERNEL_DIR ?= /lib/modules/$(shell uname -r)/build
 
-all:
-	$(MAKE) -C /lib/modules/$(KVERSION)/build M=$(PWD) modules
+KERNEL_MAKE_OPTS := -C $(KERNEL_DIR) M=$(CURDIR)
+ifneq ($(ARCH),)
+KERNEL_MAKE_OPTS += ARCH=$(ARCH)
+endif
+ifneq ($(CROSS_COMPILE),)
+KERNEL_MAKE_OPTS += CROSS_COMPILE=$(CROSS_COMPILE)
+endif
+ifneq ($(INSTALL_MOD_PATH),)
+KERNEL_MAKE_OPTS += INSTALL_MOD_PATH=$(INSTALL_MOD_PATH)
+endif
+
+build:
+	$(MAKE) $(KERNEL_MAKE_OPTS) modules
+
+modules_install:
+	$(MAKE) $(KERNEL_MAKE_OPTS) modules_install
 
 clean:
-	$(MAKE) -C /lib/modules/$(KVERSION)/build M=$(PWD) clean
+	$(MAKE) $(KERNEL_MAKE_OPTS) clean
-- 
2.39.5

