#!/bin/bash

# Copyright 2017-2025 NXP
#
# SPDX-License-Identifier: BSD-3-Clause


build_distro_rfs_debian() {
    [ $DISTROTYPE = debian -a -f $RFSDIR/etc/buildinfo ] && log_mute echo $RFSDIR already exists! && exit 0
    [ `whoami` = root ] && sudopt="" || sudopt=sudo

    fbprint_n "Generating initial rootfs: $RFSDIR ... \\nThis might take some time, please be patient" && cd $FBDIR
    test -c $RFSDIR/dev/pts/ptmx && $sudopt umount $RFSDIR/dev/pts
    test -f $RFSDIR/proc/uptime && $sudopt umount $RFSDIR/proc
    [ -n "$RFSDIR" ] && $sudopt rm -rf $RFSDIR/*

    if [ "$FETCH_PREBUILT_SDK_RFS" = y -a "$FORCE" != y ]; then
	echo FETCH_PREBUILT_SDK_RFS is enable by default in $CFGLISTYML
	rootfsn=rootfs_${DISTRIB_VERSION}_${DISTROTYPE}_${DISTROVARIANT}_${DESTARCH}.tar.zst
	rootfs_url=$DISTRO_SVR_URL/$DISTRIB_VERSION/$rootfsn
	if [ ! -f $FBOUTDIR/images/$rootfsn ]; then
	   cd $FBOUTDIR/images
	   log_mute wget --progress=bar:force $rootfs_url || true
	   cd -
	fi
	[ -f $FBOUTDIR/images/$rootfsn ] && echo Extracting $rootfsn && \
	$sudopt tar -I zstd -xf $FBOUTDIR/images/$rootfsn -C $RFSDIR && \
	fbprint_d $RFSDIR && exit || echo Building $RFSDIR from scratch
    fi

    if [ ! -f $PKGDIR/${DEBIAN_CODENAME}_${DISTROVARIANT}_$DESTARCH/rootfs/etc/buildinfo ]; then
	[ -f /usr/bin/bdebstrap ] || log_mute $sudopt apt install -y bdebstrap
	[ -f $PKGDIR/${DEBIAN_CODENAME}_${DISTROVARIANT}_$DESTARCH ] || \
	log_mute $sudopt bdebstrap -c $FBDIR/configs/debian/${DISTROTYPE}_${DISTROVARIANT}_${DESTARCH}.yaml --name \
	     $PKGDIR/${DEBIAN_CODENAME}_${DISTROVARIANT}_$DESTARCH $mirroropt -f
    fi

    [ -f $RFSDIR/etc/buildinfo ] || $sudopt rsync -aHAX $PKGDIR/${DEBIAN_CODENAME}_${DISTROVARIANT}_$DESTARCH/rootfs/* $RFSDIR

    if [ $DISTROVARIANT = server -o $DISTROVARIANT = desktop ]; then
	log_mute $sudopt chroot $RFSDIR apt update
	[ $DISTROVARIANT = server ] && log_mute $sudopt chroot $RFSDIR apt install -y $extra_server_devel_packages
	[ $DISTROVARIANT = desktop ] && log_mute $sudopt chroot $RFSDIR apt install -y $extra_server_devel_packages $extra_desktop_devel_packages

	# set U-Boot version info in userland to be readable in linux runtime
	[ -d $FBOUTDIR/bsp/u-boot ] && uvfile=$(find $FBOUTDIR/bsp/u-boot/*/output/*/include/generated -name version_autogenerated.h | head -1)
	if [ -n "$uvfile" -a -f $uvfile ]; then
	    ubootVersion=`head -1 $uvfile | cut -d' ' -f3`
	    ubootVersion=`echo $ubootVersion | sed 's/\"//g'`
	    echo -e "Bootloader Version: U-Boot $ubootVersion" | $sudopt tee -a $RFSDIR/etc/buildinfo 1>/dev/null
	fi

	# clean cached packages
	log_mute $sudopt chroot $RFSDIR apt clean
	log_mute $sudopt chroot $RFSDIR apt autoclean
	log_mute $sudopt chroot $RFSDIR apt autoremove -y
    fi

    # fix absolute path for libz.so symlink when cross compiling apitrace
    $sudopt ln -sf libz.so.1 $RFSDIR/usr/lib/aarch64-linux-gnu/libz.so

    # fixup for libtinfo.so needed by tsntool
    $sudopt ln -sf libtinfo.so.6 $RFSDIR/usr/lib/aarch64-linux-gnu/libtinfo.so

    # fixup for Qt6 app cross-compiling
    $sudopt ln -sf libQt6Quick.so.6 $RFSDIR/usr/lib/aarch64-linux-gnu/libQt6Quick.so
    $sudopt ln -sf libQt6OpenGL.so.6 $RFSDIR/usr/lib/aarch64-linux-gnu/libQt6OpenGL.so
    $sudopt ln -sf libQt6QmlModels.so.6 $RFSDIR/usr/lib/aarch64-linux-gnu/libQt6QmlModels.so
    $sudopt ln -sf libQt6Qml.so.6 $RFSDIR/usr/lib/aarch64-linux-gnu/libQt6Qml.so

    echo -e 'export PYTHONPATH=$PYTHONPATH:/usr/lib/python3.11/site-packages:/usr/lib/python3/dist-packages' | $sudopt tee -a $RFSDIR/etc/profile 1>/dev/null

    # fix ping: socket: Operation not permitted
    $sudopt chmod u+s $RFSDIR/bin/ping

    # fix login issue for desktop
    if [ $DISTROVARIANT = desktop ]; then
		sed -i "s/.*pam_nologin.*/auth    requisite       pam_nologin.so nullok/" $RFSDIR/etc/pam.d/gdm-password
		sed -e  's/.*AutomaticLoginEnable.*/AutomaticLoginEnable = true/'  -e '0,/user1/s/.*user1.*/AutomaticLogin = debian/'  -i $RFSDIR/etc/gdm3/daemon.conf
		sed -i '$a\[Install]\nWantedBy=graphical.target\n' $RFSDIR/lib/systemd/system/gdm.service
		rm -rf $RFSDIR/etc/systemd/system/display-manager.service
		ln -sf /lib/systemd/system/gdm.service $RFSDIR/etc/systemd/system/graphical.target.wants/gdm.service
    fi

    fbprint_d $RFSDIR
}
